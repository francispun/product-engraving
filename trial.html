<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <title>Knife Engraving Customiser</title>
  <link rel="icon" href="./favicon.ico" type="image/x-icon">

  <!-- load all fonts at once -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?
      family=Montserrat:wght@400;700
      &family=Lobster
      &family=Roboto
      &family=Chocolate+Classical+Sans
      &family=LXGW+WenKai+Mono+TC
      &family=Noto+Sans+HK
      &family=Noto+Serif+TC
      &display=swap"
    rel="stylesheet">

  <!-- JSZip for producing the ZIP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>

  <style>
    :root {
      --accent: #d00024;
      --bg: #fafafa;
      --border: #ddd;
      --pad: 1rem;
      --radius: .5rem;
    }
    * { box-sizing:border-box; margin:0; }
    body {
      font-family: Roboto, Arial, sans-serif;
      background:var(--bg); color:#222;
    }
    h1,h2 { text-align:center; margin:1rem 0; }
    .container {
      max-width:1200px; margin:auto; padding:var(--pad);
      display:flex; flex-direction:column; gap:var(--pad);
    }
    .section {
      background:#fff; border:1px solid var(--border);
      border-radius:var(--radius); padding:var(--pad);
    }
    #product-picker {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      gap:.75rem;
    }
    .product-option { text-align:center; }
    .product-option input {
      position:absolute; opacity:0; cursor:pointer;
      width:100%; height:100%;
    }
    .product-option img {
      width:100%; border:2px solid transparent;
      border-radius:var(--radius);
    }
    .product-option input:checked+img {
      border-color:var(--accent);
    }
    #editors { display:flex; flex-direction:column; gap:var(--pad); }
    .editor {
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:var(--pad);
    }
    .controls {
      display:flex; flex-wrap:wrap; gap:1rem; align-items:center;
      margin-bottom:1rem;
    }
    .controls label { font-size:.9rem; }
    .canvas‐wrapper {
      position:relative;
      max-width:1168px;
      margin:auto;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:#eaeaea;
      touch-action:none;
    }
    canvas { display:block; width:100%; touch-action:none; }
    .loading {
      position:absolute; inset:0;
      background:rgba(255,255,255,0.8);
      display:flex; align-items:center; justify-content:center;
      visibility:hidden; font-size:1.2rem; color:#555;
    }
    button {
      background:var(--accent); color:#fff; border:none;
      padding:.6rem 1rem; border-radius:var(--radius);
      cursor:pointer; font-weight:600;
    }
    button[disabled] { opacity:.4; cursor:not-allowed; }
    @media(max-width:600px){
      .controls { flex-direction:column; align-items:flex-start; }
    }
  </style>
</head>
<body>
  <h1>Knife Engraving Customiser</h1>
  <div class="container">

    <!-- 1. knife picker -->
    <div class="section">
      <h2>1. Choose your knives</h2>
      <div id="product-picker">
        <label class="product-option">
          <input type="checkbox" value="chef.jpg"><img src="chef-thumb.jpg" alt="Chef">
        </label>
        <label class="product-option">
          <input type="checkbox" value="santoku.jpg"><img src="santoku-thumb.jpg" alt="Santoku">
        </label>
        <label class="product-option">
          <input type="checkbox" value="bread.jpg"><img src="bread-thumb.jpg" alt="Bread">
        </label>
        <label class="product-option">
          <input type="checkbox" value="chopper.jpg"><img src="chopper-thumb.jpg" alt="Chopper">
        </label>
        <label class="product-option">
          <input type="checkbox" value="utility.jpg"><img src="utility-thumb.jpg" alt="Utility">
        </label>
        <label class="product-option">
          <input type="checkbox" value="paring.jpg"><img src="paring-thumb.jpg" alt="Paring">
        </label>
      </div>
    </div>

    <!-- 2+3. dynamic editor per knife -->
    <div id="editors"></div>

    <!-- 4. ZIP download -->
    <div class="section" style="text-align:center">
      <button id="downloadZip" disabled>
        Generate &amp; Download ZIP
      </button>
    </div>
  </div>

  <script>
  (function(){
    const picker = document.getElementById('product-picker');
    const editorsDiv = document.getElementById('editors');
    const downloadZip = document.getElementById('downloadZip');

    // load image helper
    function loadImage(src){
      return new Promise(res=>{
        const i=new Image();
        i.crossOrigin='anonymous';
        i.onload=()=>res(i);
        i.src=src;
      });
    }

    // whenever selection changes, rebuild editors
    picker.addEventListener('change', buildEditors);

    async function buildEditors(){
      editorsDiv.innerHTML = '';
      const checked = Array.from(
        picker.querySelectorAll('input:checked')
      ).map(i=>i.value);
      downloadZip.disabled = !checked.length;

      for(const src of checked){
        const img = await loadImage(src);
        const sec = document.createElement('div');
        sec.className = 'section editor';
        sec.innerHTML = `
          <h2>${src.replace('.jpg','').toUpperCase()}</h2>
          <div class="controls">
            <label>Text: <input type="text" class="txt" placeholder="Enter engraving"></label>
            <label>Font:
              <select class="font">
                <optgroup label="English">
                  <option value="Montserrat">Montserrat</option>
                  <option value="Roboto">Roboto</option>
                  <option value="Lobster">Lobster</option>
                  <option value="'Times New Roman',serif">Times New Roman</option>
                  <option value="Courier New">Courier New</option>
                  <option value="Arial">Arial</option>
                </optgroup>
                <optgroup label="Chinese">
                  <option value="'Chocolate Classical Sans',sans-serif">Chocolate Classical Sans</option>
                  <option value="'LXGW WenKai Mono TC',monospace">LXGW WenKai Mono TC</option>
                  <option value="'Noto Sans HK',sans-serif">Noto Sans HK</option>
                  <option value="'Noto Serif TC',serif">Noto Serif TC</option>
                </optgroup>
              </select>
            </label>
          </div>
          <div class="canvas-wrapper">
            <canvas></canvas>
            <div class="loading">Loading…</div>
          </div>`;
        editorsDiv.appendChild(sec);

        // grab elements & contexts
        const canvas = sec.querySelector('canvas');
        const ctx    = canvas.getContext('2d');
        const full   = document.createElement('canvas');
        const fCtx   = full.getContext('2d');
        const overlay= sec.querySelector('.loading');
        const txtIn  = sec.querySelector('.txt');
        const fontSel= sec.querySelector('.font');

        // state
        const state = {
          img, baseFont:150, textScale:1,
          dim:{w:0,h:0}, pos:{x:0,y:0}
        };

        // fit canvas to wrapper width (~1168px max)
        function fit(){
          const wrap = sec.querySelector('.canvas-wrapper');
          const W = wrap.clientWidth;
          const scale = W / img.naturalWidth;
          canvas.width  = img.naturalWidth * scale;
          canvas.height = img.naturalHeight * scale;
          full.width    = img.naturalWidth;
          full.height   = img.naturalHeight;
          canvas.style.width  = canvas.width + 'px';
          canvas.style.height = canvas.height+ 'px';

          // start text right-aligned with 50px margin
          state.dim = measure();
          state.textScale = 1;
          state.pos.x = full.width - 50;
          state.pos.y = (full.height - state.dim.h)/2;
        }

        // measure unscaled text
        function measure(){
          fCtx.font = `${state.baseFont}px ${fontSel.value}`;
          return {
            w: fCtx.measureText(txtIn.value).width,
            h: state.baseFont
          };
        }

        // draw both full & preview
        async function draw(){
          overlay.style.visibility = 'visible';
          // ensure font is loaded
          await document.fonts.load(`${state.baseFont * state.textScale}px ${fontSel.value}`);

          // 1) full-res
          fCtx.clearRect(0,0,full.width,full.height);
          fCtx.drawImage(img,0,0);
          fCtx.font = `${state.baseFont*state.textScale}px ${fontSel.value}`;
          fCtx.textBaseline = 'top';
          fCtx.textAlign    = 'right';
          fCtx.fillStyle    = '#000';
          fCtx.fillText(txtIn.value, state.pos.x, state.pos.y);

          // 2) preview
          const s = canvas.width/full.width;
          ctx.setTransform(s,0,0,s,0,0);
          ctx.clearRect(0,0,full.width,full.height);
          ctx.drawImage(img,0,0);
          ctx.font = `${state.baseFont*state.textScale}px ${fontSel.value}`;
          ctx.textBaseline = 'top';
          ctx.textAlign    = 'right';
          ctx.fillStyle    = '#000';
          ctx.fillText(txtIn.value, state.pos.x, state.pos.y);
          ctx.setTransform(1,0,0,1,0,0);

          overlay.style.visibility = 'hidden';
        }

        // init
        fit();
        await draw();

        // redraw on text or font change
        txtIn.addEventListener('input', ()=>{
          state.dim = measure();
          state.textScale = 1;
          state.pos.y = (full.height - state.dim.h)/2;
          draw();
        });
        fontSel.addEventListener('change', ()=>{
          state.dim = measure();
          state.textScale = 1;
          state.pos.y = (full.height - state.dim.h)/2;
          draw();
        });

        // keep for ZIP
        sec._state = state;
        sec._full  = full;
      }
    }

    // ZIP download
    downloadZip.addEventListener('click', async ()=>{
      const zip = new JSZip();
      for(const sec of editorsDiv.children){
        const name = sec.querySelector('h2').textContent.toLowerCase();
        const state = sec._state;
        const full  = sec._full;
        // ensure latest draw
        await (state.draw?.() || Promise.resolve());

        // preview.png
        const blobP = await new Promise(r=> full.toBlob(r,'image/png'));
        zip.file(`${name}-preview.png`, blobP);

        // text-only.png
        const textOnly = document.createElement('canvas');
        textOnly.width  = full.width;
        textOnly.height = full.height;
        const tctx = textOnly.getContext('2d');
        tctx.font = `${state.baseFont*state.textScale}px ${sec.querySelector('.font').value}`;
        tctx.textBaseline = 'top';
        tctx.textAlign = 'right';
        tctx.fillStyle = '#000';
        tctx.fillText(sec.querySelector('.txt').value, state.pos.x, state.pos.y);
        const blobT = await new Promise(r=> textOnly.toBlob(r,'image/png'));
        zip.file(`${name}-text-only.png`, blobT);
      }
      const content = await zip.generateAsync({type:'blob'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(content);
      a.download = 'knives.zip';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},100);
    });

    // initial build
    buildEditors();
  })();
  </script>
</body>
</html>
