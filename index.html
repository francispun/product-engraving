<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Knife Engraving Customiser</title>
<link rel="icon" type="image/x-icon" href="./favicon.ico">

<!-- faster Google-fonts -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Lobster&family=Roboto&display=swap" rel="stylesheet">

<style>
:root{--accent:#d00024;--bg:#fafafa;--border:#ddd;--pad:1rem;--radius:.5rem;}
*{box-sizing:border-box;margin:0;}
body{font-family:Roboto,Arial,Helvetica,sans-serif;background:var(--bg);color:#222;}
h1{text-align:center;margin:1.75rem 0 1rem;}
h2{margin:15px 0px;}
h3{text-align:center;}
.container{max-width:1200px;margin:auto;padding:var(--pad);display:flex;flex-direction:column;gap:var(--pad);}
.section{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:var(--pad);}
#product-picker{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:.75rem;}
.product-option{position:relative;}
.product-option input{position:absolute;inset:0;opacity:0;cursor:pointer;}
.product-option img{width:100%;border:2px solid transparent;border-radius:var(--radius);display:block;}
.product-option input:checked+img{border-color:var(--accent);}
.controls{display:flex;flex-wrap:wrap;gap:1rem;align-items:center;}
.controls label{font-size:.9rem;margin-right:.25rem;}
#canvas-wrapper{width:100%;max-width:1168px;max-height:1168px;margin:auto;overflow:hidden;border:1px solid var(--border);border-radius:var(--radius);background:#eaeaea;text-align:center;}
canvas{touch-action:none;display:block;width:100%;height:auto;}
button{background:var(--accent);color:#fff;border:none;padding:.6rem 1rem;border-radius:var(--radius);cursor:pointer;font-weight:600;}
button[disabled]{opacity:.4;cursor:not-allowed;}
@media(max-width:600px){.controls{flex-direction:column;align-items:flex-start;}}
</style>
</head>
<body>
<h1>Knife Engraving Customiser</h1>
<h3>by <span><img src="kool-logo.png" alt="logo" style="width:50px;vertical-align:bottom;"> </span></h3>
<div class="container">

  <!-- 1. KNIFE -->
  <div class="section">
    <h2 style="margin-top:0;">1. Choose your knife</h2>
    <div id="product-picker">
      <label class="product-option"><input type="radio" name="product" value="chef.jpg"><img src="chef.jpg" alt="Chef knife"></label>
      <label class="product-option"><input type="radio" name="product" value="santoku.jpg"><img src="santoku.jpg" alt="Santoku knife"></label>
      <label class="product-option"><input type="radio" name="product" value="paring.jpg"><img src="paring.jpg" alt="Paring knife"></label>
      <label class="product-option"><input type="radio" name="product" value="utility.jpg"><img src="utility.jpg" alt="Utility knife"></label>
    </div>
  </div>

  <!-- 2. TEXT CONTROLS -->
  <div class="section">
    <h2 style="margin-top:0;">2. Customise text</h2>
    <div class="controls">
      <div><label for="engraveText">Text:</label><input type="text" id="engraveText" placeholder="Enter engraving"></div>
      <div><label for="fontSelect">Font:</label>
        <select id="fontSelect">
          <option value="Montserrat">Montserrat</option>
          <option value="Roboto">Roboto</option>
          <option value="Lobster">Lobster</option>
          <option value="'Times New Roman',serif">Times New Roman</option>
          <option value="Courier New">Courier New</option>
          <option value="Arial">Arial</option>
        </select>
      </div>
      <div><label for="fontSize">Size:</label><input type="number" id="fontSize" value="150" min="10" max="800" style="width:5rem;"></div>
    </div>
  </div>

  <!-- 3. PREVIEW & DOWNLOAD -->
  <div class="section">
    <h2 style="margin-top:0;">3. Drag the text to position</h2>
    <div id="canvas-wrapper"><canvas id="viewCanvas"></canvas></div>
    <div style="text-align:center;margin-top:1rem;">
      <button id="downloadBtn" disabled>Generate & Download PNGs</button>
    </div>
  </div>

</div>

<script>
/* ──────────────────────────────────────────────────────────────
   ELEMENTS & GLOBAL STATE
────────────────────────────────────────────────────────────────*/
const view       = document.getElementById('viewCanvas');
const vCtx       = view.getContext('2d');
const full       = document.createElement('canvas');    // full-rez (knife + text)
const fCtx       = full.getContext('2d');
const radios     = document.querySelectorAll('[name="product"]');
const txtInput   = document.getElementById('engraveText');
const fontSel    = document.getElementById('fontSelect');
const sizeInput  = document.getElementById('fontSize');
const dlBtn      = document.getElementById('downloadBtn');
const viewport   = document.querySelector('meta[name="viewport"]');

let img = null;                 // loaded <img>
let pos = { x: 0, y: 0 };       // text position (FULL pixels)
let scale = 1;                  // view = full * scale
let dragging = false;
let pointerStart = { x: 0, y: 0 };

/* ──────────────────────────────────────────────────────────────
   HELPERS
────────────────────────────────────────────────────────────────*/
async function loadFullRes(src) {
  const blob = await fetch(src, { mode: 'cors' }).then(r => r.blob());
  const url  = URL.createObjectURL(blob);
  return new Promise(res => {
    const i = new Image();
    i.onload = () => { URL.revokeObjectURL(url); res(i); };
    i.src = url;
  });
}

function fitInBox() {
  const MAX_W = 900, MAX_H = 600;
  scale = Math.min(1, MAX_W / img.naturalWidth, MAX_H / img.naturalHeight);
  view.width  = img.naturalWidth  * scale;
  view.height = img.naturalHeight * scale;
  full.width  = img.naturalWidth;
  full.height = img.naturalHeight;
}

function draw() {
  if (!img) return;

  // full-rez
  fCtx.clearRect(0, 0, full.width, full.height);
  fCtx.drawImage(img, 0, 0);
  fCtx.font = `${sizeInput.value}px ${fontSel.value}`;
  fCtx.fillStyle = '#000';
  fCtx.textBaseline = 'top';
  fCtx.fillText(txtInput.value, pos.x, pos.y);

  // scaled preview
  vCtx.setTransform(scale, 0, 0, scale, 0, 0);
  vCtx.clearRect(0, 0, view.width / scale, view.height / scale);
  vCtx.drawImage(img, 0, 0);
  vCtx.font = `${sizeInput.value}px ${fontSel.value}`;
  vCtx.fillStyle = '#000';
  vCtx.textBaseline = 'top';
  vCtx.fillText(txtInput.value, pos.x, pos.y);
  vCtx.setTransform(1, 0, 0, 1, 0, 0);
}

function textBounds() {
  fCtx.font = `${sizeInput.value}px ${fontSel.value}`;
  return {
    w: fCtx.measureText(txtInput.value).width,
    h: parseInt(sizeInput.value, 10)
  };
}

function hitTest(fullX, fullY) {
  const { w, h } = textBounds();
  return fullX >= pos.x && fullX <= pos.x + w && fullY >= pos.y && fullY <= pos.y + h;
}

function clientToFull(clientX, clientY) {
  const rect = view.getBoundingClientRect();          // CSS pixels
  const ratioX = full.width  / rect.width;
  const ratioY = full.height / rect.height;
  return {
    x: (clientX - rect.left) * ratioX,
    y: (clientY - rect.top)  * ratioY
  };
}

function downloadCanvas(can, name) {
  can.toBlob(b => {
    const url = URL.createObjectURL(b);
    const a   = document.createElement('a');
    a.href = url; a.download = name;
    document.body.appendChild(a); a.click();
    setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 100);
  });
}

/* ──────────────────────────────────────────────────────────────
   EVENT WIRING
────────────────────────────────────────────────────────────────*/
radios.forEach(r =>
  r.addEventListener('change', async e => {
    img = await loadFullRes(e.target.value);
    fitInBox();
    // default placement = centre of blade
    pos.x = full.width * 0.5 - 150;
    pos.y = full.height * 0.5 - 25;
    draw();
    dlBtn.disabled = false;
  })
);

[txtInput, fontSel, sizeInput].forEach(el => el.addEventListener('input', draw));

/* keyboard zoom-snapping */
txtInput.addEventListener('focus', () =>
  viewport.setAttribute('content', 'width=device-width,initial-scale=1,maximum-scale=10')
);
txtInput.addEventListener('blur', () => {
  viewport.setAttribute('content', 'width=device-width,initial-scale=1,maximum-scale=1');
  setTimeout(() => window.scrollTo(0, 0), 50);
});

/* pointer-based drag */
view.addEventListener('pointerdown', e => {
  if (!img) return;
  const fullPos = clientToFull(e.clientX, e.clientY);
  if (!hitTest(fullPos.x, fullPos.y)) return;

  dragging = true;
  pointerStart = {
    dx: fullPos.x - pos.x,
    dy: fullPos.y - pos.y,
    id: e.pointerId
  };
  e.preventDefault();
});

window.addEventListener('pointermove', e => {
  if (!dragging || e.pointerId !== pointerStart.id) return;
  const fullPos = clientToFull(e.clientX, e.clientY);
  pos.x = fullPos.x - pointerStart.dx;
  pos.y = fullPos.y - pointerStart.dy;
  draw();
});

window.addEventListener('pointerup',   e => { if (e.pointerId === pointerStart.id) dragging = false; });
window.addEventListener('pointercancel', e => { if (e.pointerId === pointerStart.id) dragging = false; });

/* export both PNGs */
dlBtn.addEventListener('click', () => {
  draw();                                // make sure everything is current
  downloadCanvas(full, 'preview.png');   // knife + text
  // text-only
  const tCan = document.createElement('canvas');
  tCan.width = full.width; tCan.height = full.height;
  const tCtx = tCan.getContext('2d');
  tCtx.font = `${sizeInput.value}px ${fontSel.value}`;
  tCtx.fillStyle = '#000';
  tCtx.textBaseline = 'top';
  tCtx.fillText(txtInput.value, pos.x, pos.y);
  downloadCanvas(tCan, 'text-only.png');
});
</script>
</body>
</html>
